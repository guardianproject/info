<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>ToFU/PoP in your Android App!  (a.k.a. extending Orlib to communicate over Tor) - Guardian Project</title>
  <meta property="og:title" content="ToFU/PoP in your Android App!  (a.k.a. extending Orlib to communicate over Tor)" />
  <meta name="twitter:title" content="ToFU/PoP in your Android App!  (a.k.a. extending Orlib to communicate …" />
  <meta name="description" content="In doing my research for InformaCam, I learned a couple of neat tricks for getting an app to communicate over Tor. Here’s a how-to for app developers to use depending on your threat model, and how you have your web server set-up. Enjoy, and please post your comments/questions/suggestions below…
Before we begin… You’re going to need some basic stuff up-and-running for this to work. Before you get coding, make sure you have the following:">
  <meta property="og:description" content="In doing my research for InformaCam, I learned a couple of neat tricks for getting an app to communicate over Tor. Here’s a how-to for app developers to use depending on your threat model, and how you have your web server set-up. Enjoy, and please post your comments/questions/suggestions below…
Before we begin… You’re going to need some basic stuff up-and-running for this to work. Before you get coding, make sure you have the following:">
  <meta name="twitter:description" content="In doing my research for InformaCam, I learned a couple of neat tricks for getting an app to communicate over Tor. Here’s a how-to for app developers to use depending on your threat model, and how you …"><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Guardian Project",
    
    "url": "https://guardianproject.github.io/info"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https://guardianproject.github.io/info"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https://guardianproject.github.io/info",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https://guardianproject.github.io/info/2012/09/20/tofu/pop-in-your-android-app-a.k.a.-extending-orlib-to-communicate-over-tor/",
          "name": "To f u/ po p in your android app! (a.k.a. extending orlib to communicate over tor)"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "harlo"
  },
  "headline": "ToFU/PoP in your Android App!  (a.k.a. extending Orlib to communicate over Tor)",
  "description" : "In doing my research for InformaCam, I learned a couple of neat tricks for getting an app to communicate over Tor. Here’s a how-to for app developers to use depending on your threat model, and how you have your web server set-up. Enjoy, and please post your comments/questions/suggestions below…
Before we begin… You’re going to need some basic stuff up-and-running for this to work. Before you get coding, make sure you have the following:",
  "inLanguage" : "en",
  "wordCount": 1567,
  "datePublished" : "2012-09-20T15:17:36",
  "dateModified" : "2012-09-20T15:17:36",
  "image" : "https://guardianproject.github.io/info/Guardian_Project_LogoMark_Full_Color.svg",
  "keywords" : [ "" ],
  "mainEntityOfPage" : "https://guardianproject.github.io/info/2012/09/20/tofu/pop-in-your-android-app-a.k.a.-extending-orlib-to-communicate-over-tor/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https://guardianproject.github.io/info",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https://guardianproject.github.io/info/Guardian_Project_LogoMark_Full_Color.svg",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="ToFU/PoP in your Android App!  (a.k.a. extending Orlib to communicate over Tor)" />
<meta property="og:description" content="In doing my research for InformaCam, I learned a couple of neat tricks for getting an app to communicate over Tor. Here’s a how-to for app developers to use depending on your threat model, and how you have your web server set-up. Enjoy, and please post your comments/questions/suggestions below…
Before we begin… You’re going to need some basic stuff up-and-running for this to work. Before you get coding, make sure you have the following:">
<meta property="og:image" content="https://guardianproject.github.io/info/Guardian_Project_LogoMark_Full_Color.svg" />
<meta property="og:url" content="https://guardianproject.github.io/info/2012/09/20/tofu/pop-in-your-android-app-a.k.a.-extending-orlib-to-communicate-over-tor/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Guardian Project" />

  <meta name="twitter:title" content="ToFU/PoP in your Android App!  (a.k.a. extending Orlib to communicate …" />
  <meta name="twitter:description" content="In doing my research for InformaCam, I learned a couple of neat tricks for getting an app to communicate over Tor. Here’s a how-to for app developers to use depending on your threat model, and how you …">
  <meta name="twitter:image" content="https://guardianproject.github.io/info/Guardian_Project_LogoMark_Full_Color.svg" />
  <meta name="twitter:card" content="summary" />
  <link href='https://guardianproject.github.io/info/Guardian_Project_LogoMark_Full_Color.svg' rel='icon' type='image/x-icon'/>
  <meta property="og:image" content="https://guardianproject.github.io/info/Guardian_Project_LogoMark_Full_Color.svg" />
  <meta name="twitter:image" content="https://guardianproject.github.io/info/Guardian_Project_LogoMark_Full_Color.svg" />
  <meta name="twitter:card" content="summary" />
  <meta property="og:url" content="https://guardianproject.github.io/info/2012/09/20/tofu/pop-in-your-android-app-a.k.a.-extending-orlib-to-communicate-over-tor/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Guardian Project" />

  <meta name="generator" content="Hugo 0.54.0" />
  <link rel="alternate" href="https://guardianproject.github.io/info/index.xml" type="application/rss+xml" title="Guardian Project">

  <link rel="stylesheet" href="https://guardianproject.github.io/info/fork-awesome/css/fork-awesome.min.css" /><link rel="stylesheet" href="https://guardianproject.github.io/info/css/katex.min.css" />
  <link rel="stylesheet" href="https://guardianproject.github.io/info/css/bootstrap.min.css" /><link rel="stylesheet" href="https://guardianproject.github.io/info/css/main.css" /><link rel="stylesheet" href="https://guardianproject.github.io/info/css/fonts.css" /><link rel="stylesheet" href="https://guardianproject.github.io/info/css/syntax.css" /><link rel="stylesheet" href="https://guardianproject.github.io/info/css/codeblock.css" /><link rel="stylesheet" href="https://guardianproject.github.io/info/css/photoswipe.min.css" />
  <link rel="stylesheet" href="https://guardianproject.github.io/info/css/photoswipe.default-skin.min.css" /><script defer src="https://guardianproject.github.io/info/libresilient.js"></script>


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

	<a class="navbar-brand" title="Guardian Project" href="https://guardianproject.github.io/info"><img src="https://guardianproject.github.io/info/Guardian_Project_Horizontal_Logo_Full_Color.svg" alt="Guardian Project" height="48" style="float:left;margin-top:-15px"/>

    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent">about</a>
              <div class="navlinks-children">
                
                  <a href="https://guardianproject.github.io/info/blog/">Blog</a>
                
                  <a href="https://guardianproject.info/podcast/">podcast</a>
                
                  <a href="https://guardianproject.github.io/info/brand/">New Branding</a>
                
                  <a href="https://guardianproject.github.io/info/story/">Our Story</a>
                
                  <a href="https://guardianproject.github.io/info/partners/">Partners and Funding</a>
                
                  <a href="https://guardianproject.github.io/info/press/">Press</a>
                
                  <a href="https://guardianproject.github.io/info/services/">Services</a>
                
                  <a href="https://guardianproject.github.io/info/signing-keys/">Signing Keys</a>
                
                  <a href="https://guardianproject.github.io/info/team/">Team</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent">apps</a>
              <div class="navlinks-children">
                
                  <a href="https://guardianproject.github.io/info/apps/info.guardianproject.checkey/">Checkey: info on local apps</a>
                
                  <a href="https://guardianproject.github.io/info/apps/circulo/">Círculo</a>
                
                  <a href="https://guardianproject.github.io/info/apps/org.havenapp.main/">Haven</a>
                
                  <a href="https://guardianproject.github.io/info/apps/info.guardianproject.locationprivacy/">Location Privacy - BETA</a>
                
                  <a href="https://guardianproject.github.io/info/apps/org.witness.sscphase1/">ObscuraCam: The Privacy Camera</a>
                
                  <a href="https://guardianproject.github.io/info/apps/org.torproject.android/">Orbot: Proxy with Tor</a>
                
                  <a href="https://guardianproject.github.io/info/apps/info.guardianproject.orfox/">Orfox</a>
                
                  <a href="https://guardianproject.github.io/info/apps/info.guardianproject.pixelknot/">PixelKnot: Hidden Messages</a>
                
                  <a href="https://guardianproject.github.io/info/apps/org.witness.proofmode/">ProofMode: Verified Visuals</a>
                
                  <a href="https://guardianproject.github.io/info/apps/info.guardianproject.ripple/">Ripple: respond when panicking</a>
                
                  <a href="https://guardianproject.github.io/info/apps/net.opendasharchive.openarchive.release/">Save</a>
                
                  <a href="https://guardianproject.github.io/info/apps/org.torproject.torbrowser/">Tor Browser for Android</a>
                
                  <a href="https://guardianproject.github.io/info/apps/org.torproject.torbrowser_alpha/">Tor Browser for Android (Alpha)</a>
                
                  <a href="https://guardianproject.github.io/info/apps/org.torproject.torservices/">TorServices (alpha)</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent">code</a>
              <div class="navlinks-children">
                
                  <a href="https://guardianproject.github.io/info/code/cleaninsights/">Clean Insights: Privacy Preserving Measurement</a>
                
                  <a href="https://guardianproject.github.io/info/code/iocipher/">IOCipher: Virtual Encrypted Disks</a>
                
                  <a href="https://guardianproject.github.io/info/code/netcipher/">NetCipher: Secured Networking</a>
                
                  <a href="https://guardianproject.github.io/info/code/panickit/">PanicKit: system-wide panic responses</a>
                
                  <a href="https://guardianproject.github.io/info/code/sqlcipher/">SQLCipher: Encrypted Database</a>
                
                  <a href="https://guardianproject.github.io/info/code/tor-android/">TorService: Tor library for Android</a>
                
                  <a href="https://guardianproject.github.io/info/code/trustedintents/">TrustedIntents: flexible trusted interactions between Android apps</a>
                
                  <a href="https://guardianproject.github.io/info/code/wind/">Wind: Off-Grid Services for Everyday People</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent">archive</a>
              <div class="navlinks-children">
                
                  <a href="https://guardianproject.github.io/info/archive/apps/">Archived Apps</a>
                
                  <a href="https://guardianproject.github.io/info/archive/cacheword/">CacheWord: Passphrase Caching and Management</a>
                
                  <a href="https://guardianproject.github.io/info/archive/camerav/">CameraV: Secure Verifiable Photo &amp; Video Camera</a>
                
                  <a href="https://guardianproject.github.io/info/archive/courier/">Courier: Secure News reader</a>
                
                  <a href="https://guardianproject.github.io/info/archive/developersquare/">Developer Square</a>
                
                  <a href="https://guardianproject.github.io/info/archive/ffmpeg/">FFMPEG: Media Privacy Framework</a>
                
                  <a href="https://guardianproject.github.io/info/archive/firefoxprivacy/">Firefox Mobile: Privacy Enhanced</a>
                
                  <a href="https://guardianproject.github.io/info/freebird/">Freebird Workshop</a>
                
                  <a href="https://guardianproject.github.io/info/archive/gnupg/">GnuPG: OpenPGP Encryption</a>
                
                  <a href="https://guardianproject.github.io/info/archive/hardware/">Hardware Guide</a>
                
                  <a href="https://guardianproject.github.io/info/archive/informacam/">InformaCam: Verified Mobile Media</a>
                
                  <a href="https://guardianproject.github.io/info/archive/keysync/">KeySync: Syncing Trusted Identities</a>
                
                  <a href="https://guardianproject.github.io/info/archive/luks/">LUKS: Disk Encryption</a>
                
                  <a href="https://guardianproject.github.io/info/archive/lildebi/">Lil&#39; Debi: Mobile Debian Installer</a>
                
                  <a href="https://guardianproject.github.io/info/archive/onionkit/">OnionKit for Android</a>
                
                  <a href="https://guardianproject.github.io/info/archive/orbot/">Orbot: Tor for Android</a>
                
                  <a href="https://guardianproject.github.io/info/archive/orweb/">Orweb: Private Web Browser</a>
                
                  <a href="https://guardianproject.github.io/info/archive/ostel/">Ostel: Encrypted Phone Calls</a>
                
                  <a href="https://guardianproject.github.io/info/archive/pixelknot/">Pixelknot: Hidden Messages</a>
                
                  <a href="https://guardianproject.github.io/info/archive/tutorials/">Tutorials</a>
                
                  <a href="https://guardianproject.github.io/info/archive/weatherrepo/">Weather Repo</a>
                
                  <a href="https://guardianproject.github.io/info/archive/libsqlfs/">libsqlfs: filesystem on top of SQLite/SQLCipher</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent">contact</a>
              <div class="navlinks-children">
                
                  <a href="https://guardianproject.github.io/info/contact/">Contact</a>
                
                  <a href="https://guardianproject.github.io/info/how-you-can-work-with-us/">How You Can Work With Us</a>
                
                  <a href="https://guardianproject.github.io/info/contact/join/">Jobs and Internships</a>
                
                  <a href="https://guardianproject.github.io/info/contact/chat/">Live Chatrooms</a>
                
                  <a href="https://social.librem.one/@guardianproject">Toot @guardianproject@librem.one</a>
                
                  <a href="https://twitter.com/guardianproject">Tweet @guardianproject</a>
                
              </div>
            </li>
          
        

            <li class="navlinks-container">
              <a class="navlinks-parent" title="Language">
		<i class="fa fa-language" style="font-size: 1.75em"></i>
	      </a>
	      
            </li>

        
      </ul>
    </div>
  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  







  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="blog-heading">
              
                <h1>ToFU/PoP in your Android App!  (a.k.a. extending Orlib to communicate over Tor)</h1>
              
              
                <hr class="small">
              
              
              
                <span class="post-meta">
  
  <i class="fa fa-calendar"></i>&nbsp;Posted on September 20, 2012
  
  
  
    &nbsp;|&nbsp;<i class="fa fa-user"></i>&nbsp;harlo
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        

<p>In doing my research for InformaCam, I learned a couple of neat tricks for getting an app to communicate over Tor. Here’s a how-to for app developers to use depending on your threat model, and how you have your web server set-up. Enjoy, and please post your comments/questions/suggestions below…</p>

<h2 id="before-we-begin">Before we begin…</h2>

<p>You’re going to need some basic stuff up-and-running for this to work. Before you get coding, make sure you have the following:</p>

<p><strong>Your Android device should have:</strong></p>

<ul>
<li>Orbot downloaded and running</li>
<li>An encrypted data store to save keys, certificates, and addresses to, such as Guardian Project’s <a href="https://github.com/guardianproject/sqlcipher-android" target="_blank">SQLCipher</a> or <a href="https://github.com/guardianproject/IOCipher" target="_blank">IOCipher</a>. (SQLCipher is a database; if you want to have records for each hidden service such as “Onion Address,” “Certificate,” “Display Name,” etc. this is the model you can use. IOCipher is used like an encrypted java.io.File partition; you could easily store certificates in a java keystore with a .jks extension, and save a text file with a list of onion addresses. However you manage your backend is up to you.)</li>
</ul>

<p><strong>Your server should have:</strong></p>

<ul>
<li>A lightweight web server. According to the Tor documentation, smaller servers like LightTPD are preferred over Apache since there’s less of an opportunity to accidentally reveal your IP address in error logs or publicly-accessible config files.</li>
<li>Tor set up and running a hidden service</li>
<li>Your own self-signed SSL certificate for your server. (Directions can be found <a href="http://www.digicert.com/ssl-certificate-installation-lighttpd.htm" target="_blank">here</a>)</li>
<li><em>For extra credit,</em> you can set yourself up your own certificate authority. This can be used to sign client authentication keys (how you distribute them to users is also up to you) and directions to do this can be found <a href="http://it.toolbox.com/blogs/securitymonkey/howto-securing-a-website-with-client-ssl-certificates-11500" target="_blank">here</a>.</li>
</ul>

<h2 id="ok-let-s-get-coding">Ok, let’s get coding!</h2>

<ol>
<li><p><strong>Use case: I don’t actually need Tor support, but I do want to add my custom SSL certificate to the app’s trust chain.</strong></p>
What you need to do this is to create a custom Trust Manager, and use it when you instantiate your SSL connection.</p>

<p>In this example, the trust manager loads (or creates, if it’s the first time use) your encrypted keystore. When your app makes a request to your web server, the Trust Manager will first check to see if the host name is in your “white list” (either in your SQLite database or in the encrypted flat file you created.) If that checks out, the Trust Manager will add the X509 certificate to your encrypted keystore (if it doesn’t exist there already.) I’ve omitted the part of the code where you load up your keystore, and where you save any changes to it; you can do that on your own, depending on how you have it set up.</p>

<p>The following code I cribbed heavily from <a href="https://github.com/ge0rg/MemorizingTrustManager" target="_blank">ge0rg’s memorizing trust manager</a>. Please have a look at that, too, and thank the guy for his great work!</p>

<p><pre style="font-size:0.8em;">public class MyTrustManager implements X509TrustManager {
private KeyStore keyStore;
private X509TrustManager defaultTrustManager;
private X509TrustManager appTrustManager;</p>

<p>byte[] keyStored = null;
String pwd;</p>

<p>public MyTrustManager() {
    loadKeyStore();</p>

<pre><code>defaultTrustManager = getTrustManager(false);
appTrustManager = getTrustManager(true);
</code></pre>

<p>}</p>

<p>private X509TrustManager getTrustManager(boolean withKeystore) {
    try {
        TrustManagerFactory tmf = TrustManagerFactory.getInstance(&ldquo;X509&rdquo;);
        if(withKeystore)
            tmf.init(keyStore);
        else
            tmf.init((KeyStore) null);
        for(TrustManager t : tmf.getTrustManagers())
            if(t instanceof X509TrustManager)
                return (X509TrustManager) t;
    } catch (KeyStoreException e) {
        Log.e(LOG, &ldquo;key store exception: &ldquo; + e.toString());
    } catch (NoSuchAlgorithmException e) {
        Log.e(LOG, &ldquo;no such algo exception: &ldquo; + e.toString());
    }
    return null;
}</p>

<p>private void loadKeyStore() {
    //TODO: this is where you load up your keystore and store the bytes into the keyStored field if neccessary.
    try {
        keyStore = KeyStore.getInstance(KeyStore.getDefaultType());
    } catch(KeyStoreException e) {
        Log.e(LOG, &ldquo;key store exception: &ldquo; + e.toString());
    }</p>

<pre><code>try {
    keyStore.load(null, null);
    if(keyStored != null)
        keyStore.load(new ByteArrayInputStream(keyStored), pwd.toCharArray());


} catch(CertificateException e) {
    Log.e(LOG, &quot;certificate exception: &quot; + e.toString());
} catch (NoSuchAlgorithmException e) {
    Log.e(LOG, &quot;no such algo exception: &quot; + e.toString());
} catch (IOException e) {
    Log.e(LOG, &quot;IOException: &quot; + e.toString());
}
</code></pre>

<p>}</p>

<p>private void storeCertificate(X509Certificate[] chain) {
    try {
        for(X509Certificate cert : chain) {
            keyStore.setCertificateEntry(cert.getSubjectDN().toString(), cert);
        }
    } catch(KeyStoreException e) {
        Log.e(LOG, &ldquo;keystore exception: &ldquo; + e.toString());
    }</p>

<pre><code>appTrustManager = getTrustManager(true);
try {
    ByteArrayOutputStream baos = new ByteArrayOutputStream();
    keyStore.store(baos, pwd.toCharArray());
    updateKeyStore(baos.toByteArray());
    Log.d(LOG, &quot;new key encountered!  length: &quot; + baos.size());
} catch(KeyStoreException e) {
    Log.e(LOG, &quot;keystore exception: &quot; + e.toString());  
} catch (NoSuchAlgorithmException e) {
    Log.e(LOG, &quot;no such algo exception: &quot; + e.toString());
} catch (IOException e) {
    Log.e(LOG, &quot;IOException: &quot; + e.toString());
} catch (CertificateException e) {
    Log.e(LOG, &quot;Certificate Exception: &quot; + e.toString());
}
</code></pre>

<p>}</p>

<p>private void updateKeyStore(byte[] newKey) {
    // TODO: this is where YOU update your own keystore if you need to (ie, if it&rsquo;s in an SQLite database)
}</p>

<p>private boolean isCertKnown(X509Certificate cert) {
    try {
        return keyStore.getCertificateAlias(cert) != null;
    } catch(KeyStoreException e) {
        return false;
    }
}</p>

<p>private boolean isExpiredException(Throwable e) {
    do {
        if(e instanceof CertificateExpiredException)
            return true;
        e = e.getCause();
    } while(e != null);
    return false;
}</p>

<p>private void checkCertificateTrusted(X509Certificate[] chain, String authType, boolean isServer) throws CertificateException {
    try {
        if(isServer)
            appTrustManager.checkServerTrusted(chain, authType);
        else
            appTrustManager.checkClientTrusted(chain, authType);
    } catch(CertificateException e) {
        if(isExpiredException(e))
            return;
        if(isCertKnown(chain[0]))
            return;</p>

<pre><code>    try {
        if(isServer)
            defaultTrustManager.checkServerTrusted(chain, authType);
        else
            defaultTrustManager.checkClientTrusted(chain, authType);
    } catch(CertificateException ce) {
        storeCertificate(chain);
    }
}
</code></pre>

<p>}</p>

<p>@Override
public void checkClientTrusted(X509Certificate[] chain, String authType) throws CertificateException {
    checkCertificateTrusted(chain, authType, false);
}</p>

<p>@Override
public void checkServerTrusted(X509Certificate[] chain, String authType) throws CertificateException {
    checkCertificateTrusted(chain, authType, true);
}</p>

<p>@Override
public X509Certificate[] getAcceptedIssuers() {
    return defaultTrustManager.getAcceptedIssuers();
}</p></li>
</ol>

<p>}
</pre></p>

<pre><code>Next, you want to initiate an Https request to use this custom Trust Manager. As most of you Android programmers know, you have to do any network stuff on another, non-UI thread. I like to use Future/Callables because it returns the contents of the web site you access into a variable that I can parse. Here’s how you do that for a standard POST request:

&lt;pre style=&quot;font-size:0.8em;&quot;&gt;public static String executeHttpsPost(final String host, final Map&lt;String, Object&gt; postData, final String contentType) {
    ExecutorService ex = Executors.newFixedThreadPool(100);
    Future&lt;String&gt; future = ex.submit(new Callable&lt;String&gt;() {
        String result = &quot;FAIL&quot;;
        String HYPHENS = &quot;--&quot;;
        STRING LINE_END = &quot;\r\n&quot;;
        String BOUNDARY = &quot;***7hisIsMyBoUND4rY***&quot;;
        String hostname;

        URL url;
        HttpsURLConnection connection;
        HostnameVerifier hnv;
        DataOutputStream dos;
        SSLContext ssl;

        MyTrustManager itm;

        private void buildQuery() {
            Iterator&lt;Entry&lt;String, Object&gt;&gt; it = postData.entrySet().iterator();

            connection.setRequestProperty(&quot;Content-Type&quot;, &quot;multipart/form-data; boundary=&quot; + BOUNDARY);
            StringBuffer sb = new StringBuffer();
            try {
                dos = new DataOutputStream(connection.getOutputStream());
                sb = new StringBuffer();
                while(it.hasNext()) {
                    sb = new StringBuffer();
                    Entry&lt;String, Object&gt; e = it.next();

                    sb.append(HYPHENS + BOUNDARY + LINE_END);

                    sb.append(&quot;Content-Disposition: form-data; name=\&quot;&quot; + e.getKey() + &quot;\&quot;&quot; + LINE_END);
                    sb.append(&quot;Content-Type: &quot; + contentType + &quot;; charset=UTF-8&quot; + LINE_END );
                    sb.append(&quot;Cache-Control: no-cache&quot; + LINE_END + LINE_END);
                    sb.append(String.valueOf(e.getValue()) + LINE_END);
                    dos.writeBytes(sb.toString());
                }

                dos.writeBytes(HYPHENS + BOUNDARY + HYPHENS + LINE_END);

                dos.flush();
                dos.close();

            } catch (IOException e) {
                Log.e(LOG, e.toString());
                e.printStackTrace();
            }
        }

        @Override
        public String call() throws Exception {
            hostname = host.split(&quot;/&quot;)[0];
            url = new URL(&quot;https://&quot; + host);

            hnv = new HostnameVerifier() {
                @Override
                public boolean verify(String hn, SSLSession session) {
                    if(hn.equals(hostname))
                        return true;
                    else
                        return false;
                }
            };

            itm = new MyTrustManager();

            ssl = SSLContext.getInstance(&quot;TLS&quot;);
            ssl.init(null, new TrustManager[] {itm}, new SecureRandom());

            HttpsURLConnection.setDefaultSSLSocketFactory(ssl.getSocketFactory());
            HttpsURLConnection.setDefaultHostnameVerifier(hnv);

            connection = (HttpsURLConnection) url.openConnection();

            connection.setRequestMethod(&quot;POST&quot;);
            connection.setRequestProperty(&quot;Connection&quot;, &quot;Keep-Alive&quot;);
            connection.setUseCaches(false);
            connection.setDoInput(true);
            connection.setDoOutput(true);

            buildQuery();

            try {
                InputStream is = connection.getInputStream();
                BufferedReader br = new BufferedReader(new InputStreamReader(is));
                String line;
                StringBuffer sb = new StringBuffer();
                while((line = br.readLine()) != null)
                    sb.append(line);
                br.close();
                connection.disconnect();
                result = sb.toString();
            } catch(NullPointerException e) {
                Log.e(LOG, e.toString());
                e.printStackTrace();
            }
            return result;
        }

    });

    try {
        return future.get();
    } catch (InterruptedException e) {
        Log.e(LOG, e.toString());
        e.printStackTrace();
        return null;
    } catch (ExecutionException e) {
        Log.e(LOG, e.toString());
        e.printStackTrace();
        return null;
    }
}
</code></pre>

<p></pre></p>

<ol>
<li><p><strong>Use case: I have a web server set up with a hidden service running. How can my app access the web site?</strong></p>
Simple! Just make some minor modifications to your SSLContext by adding a proxy! Take the executeHttpsPost method above, and add the following <em>after</em> the line “HttpsURLConnection.setDefaultHostnameVerifier(hnv);”</p>

<pre style="font-size:0.8em;">Proxy proxy = new Proxy(Proxy.Type.HTTP, new InetSocketAddress("localhost", 8118));
</pre>
    

<p>Then, change your declaration of connection to:</p>

<pre style="font-size:0.8em;">connection = (HttpsURLConnection) url.openConnection(proxy);
</pre>
    

<p>So, as long as your device is also running Orbot (Tor) you can do the same POST over Tor! </li></p>

<ul>
<li><p><strong>Use case: I have a web server that requires client authentification. How can I add a client certificate to the SSL context?</strong></p>
To do this, you’re going to need to add a KeyManager to your SSLContext. As I stated before, getting your client auth key to your app users is up to you (bluetooth, NFC, sneakernet???) but once it’s in there, and visible to your app, install it by adding your own custom KeyManager. In my testing, I added this method below to the MyTrustManager class, simply because it already had access to my encrypted keystore. But you can ostensibly place this anywhere:</p>

<p><pre style="font-size:0.8em;">public X509KeyManager[] getKeyManagers(byte[] kBytes, String clientCertificatePassword, String keystorePassword) {
KeyManagerFactory kmf = null;
KeyManager[] km = null;
X509KeyManager[] xkm = null;</p></li>
</ul>

<p>try {
    kmf = KeyManagerFactory.getInstance(&ldquo;X509&rdquo;);</p>

<pre><code>KeyStore xks = KeyStore.getInstance(&quot;PKCS12&quot;);

ByteArrayInputStream bais = new ByteArrayInputStream(kBytes);
xks.load(bais, keystorePassword.toCharArray());

kmf.init(xks, clientCertificatePassword.toCharArray());
km = kmf.getKeyManagers();
xkm = new X509KeyManager[km.length];

for(int x=0;x&gt;km.length;x++) {
    X509KeyManager k = (X509KeyManager) km[x];
    xkm[x] = k;
}
</code></pre>

<p>} catch (NoSuchAlgorithmException e) {
    Log.e(LOG, e.toString());
    e.printStackTrace();
} catch (UnrecoverableKeyException e) {
    Log.e(LOG, e.toString());
    e.printStackTrace();
} catch (KeyStoreException e) {
    Log.e(LOG, e.toString());
    e.printStackTrace();
} catch (IOException e) {
    Log.e(LOG, e.toString());
    e.printStackTrace();
} catch (CertificateException e) {
    Log.e(LOG, e.toString());
    e.printStackTrace();
}
return xkm;
}
</pre></p>

<pre><code>Finally, when you instantiate your SSLContext for your POST request, include the returned value of the getKeyManager method as the KeyManager parameter. So, replace this line:

&lt;pre style=&quot;font-size:0.8em;&quot;&gt;ssl.init(null, new TrustManager[] {itm}, new SecureRandom());
</code></pre>

<p></pre></p>

<pre><code>with this:

&lt;pre style=&quot;font-size:0.8em;&quot;&gt;X509KeyManager[] x509KeyManager = getKeyManager(kBytes, clientCertificatePassword, keystorePassword);
</code></pre>

<p>ssl.init(x509KeyManager, new TrustManager[] {itm}, new SecureRandom());
</pre></ol></p>

<p>That’s it! Good luck hacking, hackers…</p></li>
</ol>


        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://guardianproject.github.io/info/2012/08/27/sometimes-the-best-solution-is-a-library-not-an-app/" data-toggle="tooltip" data-placement="top" title="Sometimes the best solution is a library, not an app">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://guardianproject.github.io/info/2012/10/26/orbot-v11-is-out/" data-toggle="tooltip" data-placement="top" title="Orbot v11 is out!">Next Post &rarr;</a>
            </li>
          
        </ul>
      
    </div>
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
          <li>
            <a href="/index.xml" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a rel="me" href="https://social.librem.one/@guardianproject" title="mastodon">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-mastodon fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a href="https://twitter.com/guardianproject" title="twitter">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a href="https://matrix.to/#/%23guardianproject%3amatrix.org" title="matrix">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-matrix-org fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a href="https://github.com/guardianproject" title="github">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a href="https://gitlab.com/guardianproject" title="gitlab">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-gitlab fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a href="https://liberapay.com/GuardianProject" title="liberapay">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-liberapay fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          

          &nbsp;&bull;&nbsp;&copy;
          
            2009 - 2026
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://guardianproject.github.io/info">Guardian Project</a>
          
        </p>
	<p class="credits text-center text-muted">
	  
	</p>
      </div>
    </div>
  </div>
</footer><script src="https://guardianproject.github.io/info/js/katex.min.js"></script>
<script src="https://guardianproject.github.io/info/js/auto-render.min.js"></script>
<script src="https://guardianproject.github.io/info/js/jquery.min.js"></script>
<script src="https://guardianproject.github.io/info/js/bootstrap.min.js"></script>

<script src="https://guardianproject.github.io/info/js/main.js"></script><script> renderMathInElement(document.body); </script><script src="https://guardianproject.github.io/info/js/photoswipe.min.js"></script>
<script src="https://guardianproject.github.io/info/js/photoswipe-ui-default.min.js"></script><script src="https://guardianproject.github.io/info/js/load-photoswipe.js"></script>







  </body>
</html>

