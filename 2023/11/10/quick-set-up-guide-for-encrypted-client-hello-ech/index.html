<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Quick set up guide for Encrypted Client Hello (ECH) - Guardian Project</title>
  <meta property="og:title" content="Quick set up guide for Encrypted Client Hello (ECH)" />
  <meta name="twitter:title" content="Quick set up guide for Encrypted Client Hello (ECH)" />
  <meta name="description" content="The Encrypted Client Hello (ECH) mechanism draft-spec is a way to plug a few privacy-holes that remain in the Transport Layer Security (TLS) protocol that&rsquo;s used as the security layer for the web. OpenSSL is a widely used library that provides an implementation of the TLS protocol. The DEfO project has developed an implementation of ECH for OpenSSL, and proof-of-concept implementations of various clients and servers that use OpenSSL, and other TLS libraries, as a demonstration and for interoperability testing.">
  <meta property="og:description" content="The Encrypted Client Hello (ECH) mechanism draft-spec is a way to plug a few privacy-holes that remain in the Transport Layer Security (TLS) protocol that&rsquo;s used as the security layer for the web. OpenSSL is a widely used library that provides an implementation of the TLS protocol. The DEfO project has developed an implementation of ECH for OpenSSL, and proof-of-concept implementations of various clients and servers that use OpenSSL, and other TLS libraries, as a demonstration and for interoperability testing.">
  <meta name="twitter:description" content="The Encrypted Client Hello (ECH) mechanism draft-spec is a way to plug a few privacy-holes that remain in the Transport Layer Security (TLS) protocol that&rsquo;s used as the security layer for the …"><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Guardian Project",
    
    "url": "https://guardianproject.github.io/info"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https://guardianproject.github.io/info"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https://guardianproject.github.io/info",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https://guardianproject.github.io/info/2023/11/10/quick-set-up-guide-for-encrypted-client-hello-ech/",
          "name": "Quick set up guide for encrypted client hello ( e c h)"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "jochensp"
  },
  "headline": "Quick set up guide for Encrypted Client Hello (ECH)",
  "description" : "The Encrypted Client Hello (ECH) mechanism draft-spec is a way to plug a few privacy-holes that remain in the Transport Layer Security (TLS) protocol that&amp;rsquo;s used as the security layer for the web. OpenSSL is a widely used library that provides an implementation of the TLS protocol. The DEfO project has developed an implementation of ECH for OpenSSL, and proof-of-concept implementations of various clients and servers that use OpenSSL, and other TLS libraries, as a demonstration and for interoperability testing.",
  "inLanguage" : "en",
  "wordCount": 1534,
  "datePublished" : "0001-01-01T00:00:00",
  "dateModified" : "2023-11-10T00:00:00",
  "image" : "https://guardianproject.github.io/info/Guardian_Project_LogoMark_Full_Color.svg",
  "keywords" : [ "curl, DEfO, ECH, free software, nginx, open source, OpenSSL, privacy, resilience, TLS" ],
  "mainEntityOfPage" : "https://guardianproject.github.io/info/2023/11/10/quick-set-up-guide-for-encrypted-client-hello-ech/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https://guardianproject.github.io/info",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https://guardianproject.github.io/info/Guardian_Project_LogoMark_Full_Color.svg",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="Quick set up guide for Encrypted Client Hello (ECH)" />
<meta property="og:description" content="The Encrypted Client Hello (ECH) mechanism draft-spec is a way to plug a few privacy-holes that remain in the Transport Layer Security (TLS) protocol that&rsquo;s used as the security layer for the web. OpenSSL is a widely used library that provides an implementation of the TLS protocol. The DEfO project has developed an implementation of ECH for OpenSSL, and proof-of-concept implementations of various clients and servers that use OpenSSL, and other TLS libraries, as a demonstration and for interoperability testing.">
<meta property="og:image" content="https://guardianproject.github.io/info/Guardian_Project_LogoMark_Full_Color.svg" />
<meta property="og:url" content="https://guardianproject.github.io/info/2023/11/10/quick-set-up-guide-for-encrypted-client-hello-ech/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Guardian Project" />

  <meta name="twitter:title" content="Quick set up guide for Encrypted Client Hello (ECH)" />
  <meta name="twitter:description" content="The Encrypted Client Hello (ECH) mechanism draft-spec is a way to plug a few privacy-holes that remain in the Transport Layer Security (TLS) protocol that&rsquo;s used as the security layer for the …">
  <meta name="twitter:image" content="https://guardianproject.github.io/info/Guardian_Project_LogoMark_Full_Color.svg" />
  <meta name="twitter:card" content="summary" />
  <link href='https://guardianproject.github.io/info/Guardian_Project_LogoMark_Full_Color.svg' rel='icon' type='image/x-icon'/>
  <meta property="og:image" content="https://guardianproject.github.io/info/Guardian_Project_LogoMark_Full_Color.svg" />
  <meta name="twitter:image" content="https://guardianproject.github.io/info/Guardian_Project_LogoMark_Full_Color.svg" />
  <meta name="twitter:card" content="summary" />
  <meta property="og:url" content="https://guardianproject.github.io/info/2023/11/10/quick-set-up-guide-for-encrypted-client-hello-ech/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Guardian Project" />

  <meta name="generator" content="Hugo 0.54.0" />
  <link rel="alternate" href="https://guardianproject.github.io/info/index.xml" type="application/rss+xml" title="Guardian Project">

  <link rel="stylesheet" href="https://guardianproject.github.io/info/fork-awesome/css/fork-awesome.min.css" /><link rel="stylesheet" href="https://guardianproject.github.io/info/css/katex.min.css" />
  <link rel="stylesheet" href="https://guardianproject.github.io/info/css/bootstrap.min.css" /><link rel="stylesheet" href="https://guardianproject.github.io/info/css/main.css" /><link rel="stylesheet" href="https://guardianproject.github.io/info/css/fonts.css" /><link rel="stylesheet" href="https://guardianproject.github.io/info/css/syntax.css" /><link rel="stylesheet" href="https://guardianproject.github.io/info/css/codeblock.css" /><link rel="stylesheet" href="https://guardianproject.github.io/info/css/photoswipe.min.css" />
  <link rel="stylesheet" href="https://guardianproject.github.io/info/css/photoswipe.default-skin.min.css" /><script defer src="https://guardianproject.github.io/info/libresilient.js"></script>


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

	<a class="navbar-brand" title="Guardian Project" href="https://guardianproject.github.io/info"><img src="https://guardianproject.github.io/info/Guardian_Project_Horizontal_Logo_Full_Color.svg" alt="Guardian Project" height="48" style="float:left;margin-top:-15px"/>

    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent">about</a>
              <div class="navlinks-children">
                
                  <a href="https://guardianproject.github.io/info/blog/">Blog</a>
                
                  <a href="https://guardianproject.info/podcast/">podcast</a>
                
                  <a href="https://guardianproject.github.io/info/brand/">New Branding</a>
                
                  <a href="https://guardianproject.github.io/info/story/">Our Story</a>
                
                  <a href="https://guardianproject.github.io/info/partners/">Partners and Funding</a>
                
                  <a href="https://guardianproject.github.io/info/press/">Press</a>
                
                  <a href="https://guardianproject.github.io/info/services/">Services</a>
                
                  <a href="https://guardianproject.github.io/info/signing-keys/">Signing Keys</a>
                
                  <a href="https://guardianproject.github.io/info/team/">Team</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent">apps</a>
              <div class="navlinks-children">
                
                  <a href="https://guardianproject.github.io/info/apps/info.guardianproject.checkey/">Checkey: info on local apps</a>
                
                  <a href="https://guardianproject.github.io/info/apps/circulo/">Círculo</a>
                
                  <a href="https://guardianproject.github.io/info/apps/org.havenapp.main/">Haven</a>
                
                  <a href="https://guardianproject.github.io/info/apps/info.guardianproject.locationprivacy/">Location Privacy - BETA</a>
                
                  <a href="https://guardianproject.github.io/info/apps/org.witness.sscphase1/">ObscuraCam: The Privacy Camera</a>
                
                  <a href="https://guardianproject.github.io/info/apps/org.torproject.android/">Orbot: Proxy with Tor</a>
                
                  <a href="https://guardianproject.github.io/info/apps/info.guardianproject.orfox/">Orfox</a>
                
                  <a href="https://guardianproject.github.io/info/apps/info.guardianproject.pixelknot/">PixelKnot: Hidden Messages</a>
                
                  <a href="https://guardianproject.github.io/info/apps/org.witness.proofmode/">ProofMode: Verified Visuals</a>
                
                  <a href="https://guardianproject.github.io/info/apps/info.guardianproject.ripple/">Ripple: respond when panicking</a>
                
                  <a href="https://guardianproject.github.io/info/apps/net.opendasharchive.openarchive.release/">Save</a>
                
                  <a href="https://guardianproject.github.io/info/apps/org.torproject.torbrowser/">Tor Browser for Android</a>
                
                  <a href="https://guardianproject.github.io/info/apps/org.torproject.torbrowser_alpha/">Tor Browser for Android (Alpha)</a>
                
                  <a href="https://guardianproject.github.io/info/apps/org.torproject.torservices/">TorServices (alpha)</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent">code</a>
              <div class="navlinks-children">
                
                  <a href="https://guardianproject.github.io/info/code/cleaninsights/">Clean Insights: Privacy Preserving Measurement</a>
                
                  <a href="https://guardianproject.github.io/info/code/iocipher/">IOCipher: Virtual Encrypted Disks</a>
                
                  <a href="https://guardianproject.github.io/info/code/netcipher/">NetCipher: Secured Networking</a>
                
                  <a href="https://guardianproject.github.io/info/code/panickit/">PanicKit: system-wide panic responses</a>
                
                  <a href="https://guardianproject.github.io/info/code/sqlcipher/">SQLCipher: Encrypted Database</a>
                
                  <a href="https://guardianproject.github.io/info/code/tor-android/">TorService: Tor library for Android</a>
                
                  <a href="https://guardianproject.github.io/info/code/trustedintents/">TrustedIntents: flexible trusted interactions between Android apps</a>
                
                  <a href="https://guardianproject.github.io/info/code/wind/">Wind: Off-Grid Services for Everyday People</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent">archive</a>
              <div class="navlinks-children">
                
                  <a href="https://guardianproject.github.io/info/archive/apps/">Archived Apps</a>
                
                  <a href="https://guardianproject.github.io/info/archive/cacheword/">CacheWord: Passphrase Caching and Management</a>
                
                  <a href="https://guardianproject.github.io/info/archive/camerav/">CameraV: Secure Verifiable Photo &amp; Video Camera</a>
                
                  <a href="https://guardianproject.github.io/info/archive/courier/">Courier: Secure News reader</a>
                
                  <a href="https://guardianproject.github.io/info/archive/developersquare/">Developer Square</a>
                
                  <a href="https://guardianproject.github.io/info/archive/ffmpeg/">FFMPEG: Media Privacy Framework</a>
                
                  <a href="https://guardianproject.github.io/info/archive/firefoxprivacy/">Firefox Mobile: Privacy Enhanced</a>
                
                  <a href="https://guardianproject.github.io/info/freebird/">Freebird Workshop</a>
                
                  <a href="https://guardianproject.github.io/info/archive/gnupg/">GnuPG: OpenPGP Encryption</a>
                
                  <a href="https://guardianproject.github.io/info/archive/hardware/">Hardware Guide</a>
                
                  <a href="https://guardianproject.github.io/info/archive/informacam/">InformaCam: Verified Mobile Media</a>
                
                  <a href="https://guardianproject.github.io/info/archive/keysync/">KeySync: Syncing Trusted Identities</a>
                
                  <a href="https://guardianproject.github.io/info/archive/luks/">LUKS: Disk Encryption</a>
                
                  <a href="https://guardianproject.github.io/info/archive/lildebi/">Lil&#39; Debi: Mobile Debian Installer</a>
                
                  <a href="https://guardianproject.github.io/info/archive/onionkit/">OnionKit for Android</a>
                
                  <a href="https://guardianproject.github.io/info/archive/orbot/">Orbot: Tor for Android</a>
                
                  <a href="https://guardianproject.github.io/info/archive/orweb/">Orweb: Private Web Browser</a>
                
                  <a href="https://guardianproject.github.io/info/archive/ostel/">Ostel: Encrypted Phone Calls</a>
                
                  <a href="https://guardianproject.github.io/info/archive/pixelknot/">Pixelknot: Hidden Messages</a>
                
                  <a href="https://guardianproject.github.io/info/archive/tutorials/">Tutorials</a>
                
                  <a href="https://guardianproject.github.io/info/archive/weatherrepo/">Weather Repo</a>
                
                  <a href="https://guardianproject.github.io/info/archive/libsqlfs/">libsqlfs: filesystem on top of SQLite/SQLCipher</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent">contact</a>
              <div class="navlinks-children">
                
                  <a href="https://guardianproject.github.io/info/contact/">Contact</a>
                
                  <a href="https://guardianproject.github.io/info/how-you-can-work-with-us/">How You Can Work With Us</a>
                
                  <a href="https://guardianproject.github.io/info/contact/join/">Jobs and Internships</a>
                
                  <a href="https://guardianproject.github.io/info/contact/chat/">Live Chatrooms</a>
                
                  <a href="https://social.librem.one/@guardianproject">Toot @guardianproject@librem.one</a>
                
                  <a href="https://twitter.com/guardianproject">Tweet @guardianproject</a>
                
              </div>
            </li>
          
        

            <li class="navlinks-container">
              <a class="navlinks-parent" title="Language">
		<i class="fa fa-language" style="font-size: 1.75em"></i>
	      </a>
	      
            </li>

        
      </ul>
    </div>
  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  







  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="blog-heading">
              
                <h1>Quick set up guide for Encrypted Client Hello (ECH)</h1>
              
              
                <hr class="small">
              
              
              
                <span class="post-meta">
  
  <i class="fa fa-calendar"></i>&nbsp;Posted on November 10, 2023
  
  
  
    &nbsp;|&nbsp;<i class="fa fa-user"></i>&nbsp;jochensp
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        

<p>The Encrypted Client Hello (ECH) mechanism <a href="https://tools.ietf.org/html/draft-ietf-tls-esni">draft-spec</a> is a way to plug a few privacy-holes that remain in the Transport Layer Security (TLS) protocol that&rsquo;s used as the security layer for the web. OpenSSL is a widely used library that provides an implementation of the TLS protocol. The <a href="https://defo.ie/">DEfO project</a> has developed an implementation of ECH for OpenSSL, and proof-of-concept implementations of various clients and servers that use OpenSSL, and other TLS libraries, as a demonstration and for interoperability testing. DEfO is funded by the Open Technology Fund (OTF).</p>

<p>This guide is aimed at those who would like to try out ECH with our experimental Debian <em>unstable</em> packages for OpenSSL, <em>curl</em> and <em>nginx</em>. The DEfO project is making packages temporarily available so people can carry out such experiments before upstream maintainers include ECH in standard releases.</p>

<p>This guide describes two set ups: one assumes that you want to setup everything (i.e. a web server and associated DNS authoritative server) on one virtual machine and a second describes a way to set up an ECH-enabled web server if you have an existing DNS configuration elsewhere. Many other configurations are of course possible. Comments/questions are welcome via <a href="mailto:info@defo.ie">email</a> or as GitLab issues/merge requests.</p>

<p>In summary this guide shows how to:
- find and install our Debian <em>unstable</em> packages
- configure a minimal DNS setup (using dnsmasq or bind) that enables use of ECH from browsers
- configure a minimal <em>nginx</em> setup for an ECH enabled web sites
- test your DNS set up and that ECH is working</p>

<p>We assume the reader is comfortable with simple DNS management and system administration tasks.
When commands shown below should be run as <code>root</code> they are prepended with a &lsquo;#&rsquo;, if not they are prepended with a &lsquo;$&rsquo;.</p>

<h2 id="install-packages">Install packages</h2>

<p>You need to first have access to a virtual machine running Debian <em>unstable</em>. Many online resources describe many ways to do this.</p>

<p>We start with an empty (minimal) Debian <em>unstable</em> system and install OpenSSL from the DEfO apt repository.</p>

<pre><code class="language-bash"># apt install ca-certificates
# echo &quot;deb [trusted=yes] https://defo.ie/debian/ ./&quot; &gt; /etc/apt/sources.list.d/defo.list
# apt update
# apt install openssl
</code></pre>

<h2 id="pick-some-dns-names-to-use">Pick some DNS names to use</h2>

<p>In the text below we assume that the web server for which we wish to benefit from ECH is called <code>hidden.example.com</code></p>

<p>ECH also involves a so-called <code>public_name</code> - that&rsquo;s present in the outer ClientHello when ECH is used and hence is visible to a network observer, unlike the server name we include inside the Encrypted Client Hello. The <code>public_name</code> we use below is <code>example.com</code>`</p>

<p>You should obviously substitute your chosen DNS names.</p>

<h2 id="generate-an-ech-key-pair">Generate an ECH key pair</h2>

<p>For ECH to work, we need a new asymmetric key pair. (Different from those used for TLS server authentication), so next we generate an ECH key pair:</p>

<pre><code class="language-bash"># mkdir /etc/echkeydir/
# openssl ech -public_name example.com -out /etc/echkeydir/example.pem.ech
</code></pre>

<p>Note that we need this file later to set up DNS as well as <em>nginx</em>. <em>Nginx</em> will make use of the private key from the ECH key file, whilst the DNS will be used to publish the corresponding public key in an HTTPS resource record (that&rsquo;s where ECH-enabled browsers will look for ECH public keys).</p>

<p>The file name chosen should end with <code>.pem.ech</code></p>

<h2 id="set-up-dns">Set up DNS</h2>

<p>There are many ways in which one can set up the DNS records required to enable experimenting with ECH. We document two ways here, the first is where the main DNS name with which you&rsquo;re experimenting is newly registered DNS name and has no existing DNS set up. The second describes a case where a DNS name exists but we need to add some new resource records to enable ECH.</p>

<p>In both cases, <code>&lt;IP&gt;</code> should be the IPv4 address for the host running the web server. (We leave IPv6 handling as an exercise for the reader, but there&rsquo;s nothing ECH-specific required for IPv6.)</p>

<h3 id="standalone-new-setup-dnsmasq-as-a-authoritative-dns-server-to-serve-the-ech-key-on-the-same-vm">Standalone/New setup : dnsmasq as a authoritative DNS server to serve the ECH key (on the same VM)</h3>

<p>In this case we also need to pick some DNS nameserver names, we assume the authoritative primary nameserver for both web server DNS names is <code>ns.example.com</code> with a secondary of <code>ns2.example.com</code>`</p>

<p>The DNS set up to use starting from a clean dnsmasq install:</p>

<pre><code class="language-bash"># apt install dnsmasq
# cat &lt;&lt;EOF &gt; /etc/dnsmasq.d/example.conf
no-resolv
no-hosts
auth-server=ns.example.com,ns2.example.com
auth-zone=example.com
auth-sec-servers=ns2.example.com
auth-soa=42,admin.example.com
host-record=example.com,&lt;IP&gt;
host-record=hidden.example.com,&lt;IP&gt;
dns-rr=hidden.example.com,65,&lt;ascii-hex encoded HTTPS rdata&gt;
EOF
# systemctl restart dnsmasq
</code></pre>

<p>Note that you need to bump the SOA version (42 in the above) every time you change the config and make sure the zone distributes to ns2.</p>

<p>The <code>&lt;ascii-hex encoded HTTPS rdata&gt;</code> will be published as the HTTPS resource record (type == 65) for <code>hidden.example.com</code> and can be produced from the file we generated earlier via a shell script you can download and use as follows:</p>

<pre><code class="language-bash">$ _curl_ https://raw.githubusercontent.com/sftcd/openssl/ECH-draft-13c/esnistuff/pem2rr.sh -o pem2rr.sh
$ chmod u+x pem2rr.sh
$ ./pem2rr.sh /etc/echkeydir/example.pem.ech
0001000005003b0039fe0d0035db0020002059907d619054c907a1f296ceb63dde1d57f72f15db172601a2f6b55e66e7cd0f00040001000100066261722e69650000
$
</code></pre>

<h3 id="existing-dns-name-setup-using-bind-to-publish-new-ech-related-resource-records">Existing DNS name setup: using bind to publish new ECH related resource records</h3>

<p>Let&rsquo;s assume you have an existing bind-based DNS setup for <code>example.com</code><code>, but are moving the IP address for that to a new VM that'll run the ECH-enabled web server for both</code>example.com<code>and</code>hidden.example.com`<code>. The change you might then make using the bind</code>nsupdate` command on the authoritative DNS server would then look like:</p>

<ul>
<li>Change/add IP address records for our DNS names.</li>
</ul>

<pre><code class="language-bind">$ sudo nsupdate -l
&gt; update delete example.com a
&gt; update delete example.com aaaa
&gt; update add example.com 300 a &lt;IP&gt;
&gt; update add hidden.example.com 300 a &lt;IP&gt;
&gt; send
&gt; quit
$
</code></pre>

<ul>
<li>Add new HTTPS resource record for <code>hidden.example.com</code></li>
</ul>

<p>First we need to get the base64 encoded public from our <code>/etc/echkeydir/example.pem.ech</code> file:</p>

<pre><code class="language-bash">$ tail -2 /etc/echkeydir/example.pem.ech | head -1
ADr+DQA2mQAgACAF7cLT+KtK0oR2DrRCGXmzBWM1eHgJgDEGLqL644/OcAAEAAEAAQAHaG9iYS5pZQAA
$
</code></pre>

<p>That base64 encoded value is what we need to publish in the DNS&hellip;</p>

<pre><code class="language-bash">$ sudo nsupdate -l
&gt; update delete hidden.example.com HTTPS
&gt; update add hidden.example.com 300 HTTPS 1 . ech=&lt;base64-encoded-value&gt;
&gt; send
&gt; quit
$
</code></pre>

<h2 id="checking-your-dns-set-up">Checking your DNS set up</h2>

<p>You can check that value is correctly published in the DNS e.g. using the <code>dig command</code>`:</p>

<pre><code class="language-bash">$ dig +short https hidden.example.com
1 . ech=ADr+DQA2mQAgACAF7cLT+KtK0oR2DrRCGXmzBWM1eHgJgDEGLqL644/OcAAEAAEAAQAHaG9iYS5pZQAA
$
</code></pre>

<p>If your version of <code>dig</code> is older and doesn&rsquo;t know about HTTPS resource records, then you may need to check via:</p>

<pre><code class="language-bash">$ dig +short +unknownformat -t TYPE65 hidden.example.com
\# 67 0001000005003C003AFE0D0036990020002005EDC2D3F8AB4AD28476 0EB4421979B30563357878098031062EA2FAE38FCE70000400010001 0007686F62612E69650000
$
</code></pre>

<p>The 2nd-last invocation of <code>dig</code> above shows the presentation format version of the HTTPS resource record. The last invocation above shows the equivalent in ascii-hex, which (minus the spaces) is what <code>dnsmasq</code> needs in it&rsquo;s configuration file.</p>

<p>We assume <code>dnsmasq</code> will likely accept presentation format for HTTPS resource records in future as <code>bind</code> tooling already.</p>

<h2 id="set-up-nginx-to-serve-an-outer-and-an-inner-hidden-website">Set up <em>nginx</em> to serve an outer and an inner (hidden) website</h2>

<p>Install <em>nginx</em>-light from the DEfO repo, as above:</p>

<pre><code class="language-bash"># apt install _nginx_-light certbot python3-certbot-_nginx_
</code></pre>

<p>If you don&rsquo;t already have a web server config for <code>example.com</code> then you can create a basic pair of <code>sites-enabled</code> configuration files via the following commands:</p>

<pre><code class="language-bash"># rm /etc/_nginx_/sites-enabled/default
# cp /etc/_nginx_/sites-available/default /etc/_nginx_/sites-enabled/example.conf
# sed -i 's/server_name _;/server_name example.com;/' /etc/_nginx_/sites-enabled/example.conf
# echo &quot;ssl_echkeydir /etc/echkeydir/;&quot; &gt;&gt; /etc/_nginx_/sites-enabled/example.conf
# cp /etc/_nginx_/sites-available/default /etc/_nginx_/sites-enabled/hidden.example.conf
# sed -i -e 's/server_name _;/server_name hidden.example.com;/' -e sed 's/\(listen.*\)default_server;/\1;/' /etc/_nginx_/sites-enabled/hidden.example.conf
# systemctl restart _nginx_
</code></pre>

<p>It&rsquo;s possible the <code>sed</code> commands above may not work for you, e.g. if default files change, or perhaps you won&rsquo;t use those if you have an existing web server config for <code>example.com</code><code>. In that case you can simply edit the config files to ensure the following, before running</code>certbot``:</p>

<ul>
<li>you have <code>example.com</code> and <code>hidden.example.com</code> servers set up with correct <code>server_name</code>`</li>
<li>optionally change the DocRoot (<code>root</code>) in these configuration files to serve different content</li>
<li>there&rsquo;s a line within the <code>http</code> stanza as follows:
  <code>ssl_echkeydir /etc/echkeydir/;</code>`</li>
<li>the <code>ssl_echkeydir</code> line can in <code>_nginx_.conf</code> within the <code>http</code> stanza or within either of the files in <code>sites-enabled</code> when it must be outside the <code>server</code> stanza</li>
</ul>

<h2 id="run-certbot-to-get-a-tls-server-certificate">Run certbot to get a TLS server certificate</h2>

<p>Next you need to rRun <code>certbot</code> to get TLS server public keys certificates for both DNS names (<code>example.com` and `hidden.example.com</code>). Those can be in the same certificate (or not) for the purposes of this experimental setup.</p>

<pre><code class="language-bash"># certbot --nginx
...iteractions...
#
</code></pre>

<p><code>certbot</code> may prompt you for e.g. an email address or approval and if you have an existing certificate for <code>example.com</code> you may be prompted as to whether you want to add <code>hidden.example.com</code> to that certificate.</p>

<h2 id="use-curl-to-test-the-set-up">Use <em>curl</em> to test the set up</h2>

<p>Install our ECH-enabled <em>curl</em> package from the DEfO repo and run:</p>

<pre><code class="language-bash">$ curl -v --ech true --doh-url https://1.1.1.1/dns-query https://hidden.example.com/ |&amp; grep Succeeded
</code></pre>

<p>You should see this in the output:</p>

<pre><code class="language-bash">ECH: result: status is Succeeded, inner is hidden.example.com, outer is example.com
</code></pre>

<h2 id="check-with-browsers">Check with browsers</h2>

<p>If you&rsquo;re running a recent browser version (chromium-based since version 105, firefox since before then:-) you can enable ECH in the browser by <a href="https://defo.ie/#clients">following our client configuration instructions</a>. Unfortunately, browsers don&rsquo;t provide user interface to show if ECH has succeeded or not, but you can verify that your browser is able to use ECH if you visit <a href="https://defo.ie/ech-check.php">https://defo.ie/ech-check.php</a>.</p>

<h2 id="feedback">Feedback</h2>

<p>All going well, you should now have an ECH-enabled web site and be able to extend/play with that as you like. We&rsquo;d appreciate feedback on this guide if you have a chance. As before, comments/questions are welcome via <a href="mailto:info@defo.ie">email</a> or as GitLab issues/merge requests.</p>


        
          <div class="blog-tags">
            
              <a href="https://guardianproject.github.io/info/tags/curl/">curl</a>&nbsp;
            
              <a href="https://guardianproject.github.io/info/tags/defo/">DEfO</a>&nbsp;
            
              <a href="https://guardianproject.github.io/info/tags/ech/">ECH</a>&nbsp;
            
              <a href="https://guardianproject.github.io/info/tags/free-software/">free software</a>&nbsp;
            
              <a href="https://guardianproject.github.io/info/tags/nginx/">nginx</a>&nbsp;
            
              <a href="https://guardianproject.github.io/info/tags/open-source/">open source</a>&nbsp;
            
              <a href="https://guardianproject.github.io/info/tags/openssl/">OpenSSL</a>&nbsp;
            
              <a href="https://guardianproject.github.io/info/tags/privacy/">privacy</a>&nbsp;
            
              <a href="https://guardianproject.github.io/info/tags/resilience/">resilience</a>&nbsp;
            
              <a href="https://guardianproject.github.io/info/tags/tls/">TLS</a>&nbsp;
            
          </div>
        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://guardianproject.github.io/info/2023/11/09/defo-developing-ech-for-openssl-round-two/" data-toggle="tooltip" data-placement="top" title="DEfO - Developing ECH for OpenSSL (round two)">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://guardianproject.github.io/info/2024/02/24/the-future-of-our-fdroid-compatible-app-repository/" data-toggle="tooltip" data-placement="top" title="The future of our fdroid-compatible app repository">Next Post &rarr;</a>
            </li>
          
        </ul>
      
    </div>
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
          <li>
            <a href="/index.xml" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a rel="me" href="https://social.librem.one/@guardianproject" title="mastodon">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-mastodon fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a href="https://twitter.com/guardianproject" title="twitter">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a href="https://matrix.to/#/%23guardianproject%3amatrix.org" title="matrix">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-matrix-org fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a href="https://github.com/guardianproject" title="github">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a href="https://gitlab.com/guardianproject" title="gitlab">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-gitlab fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a href="https://liberapay.com/GuardianProject" title="liberapay">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-liberapay fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          

          &nbsp;&bull;&nbsp;&copy;
          
            2009 - 2025
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://guardianproject.github.io/info">Guardian Project</a>
          
        </p>
	<p class="credits text-center text-muted">
	  
	</p>
      </div>
    </div>
  </div>
</footer><script src="https://guardianproject.github.io/info/js/katex.min.js"></script>
<script src="https://guardianproject.github.io/info/js/auto-render.min.js"></script>
<script src="https://guardianproject.github.io/info/js/jquery.min.js"></script>
<script src="https://guardianproject.github.io/info/js/bootstrap.min.js"></script>

<script src="https://guardianproject.github.io/info/js/main.js"></script><script> renderMathInElement(document.body); </script><script src="https://guardianproject.github.io/info/js/photoswipe.min.js"></script>
<script src="https://guardianproject.github.io/info/js/photoswipe-ui-default.min.js"></script><script src="https://guardianproject.github.io/info/js/load-photoswipe.js"></script>







  </body>
</html>

